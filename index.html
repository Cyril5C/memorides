<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="robots" content="noindex, nofollow">
    <title>Memorides</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Memorides">
    <link rel="manifest" href="/manifest.json">

    <!-- Apple Touch Icons (use icon.svg for now, create PNG later) -->
    <link rel="apple-touch-icon" href="/icon.svg">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/icon.svg">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css?v=20251125-99">

    <!-- Inline CSS pour forcer l'affichage du bouton fullscreen -->
    <style>
        /* Photo modal doit √™tre au-dessus de la modal de trace */
        #photoModal {
            z-index: 10000 !important;
        }

        #fullscreenBtn {
            position: fixed !important;
            top: 1rem !important;
            right: 5rem !important;
            background: #ef4444 !important;
            color: white !important;
            border: none !important;
            width: 3rem !important;
            height: 3rem !important;
            border-radius: 50% !important;
            font-size: 1.5rem !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 999999 !important;
            transition: background 0.2s !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Map View -->
        <div id="mapView" class="view-container active">
            <div id="map"></div>
            <button class="settings-btn" id="settingsButton" title="G√©rer les libell√©s" style="display: none;">‚öôÔ∏è</button>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="loading-overlay hidden">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <p id="loadingText">Chargement des traces...</p>
                    <p id="loadingCounter" class="loading-counter"></p>
                </div>
            </div>

            <!-- Hamburger Menu Button -->
            <button class="hamburger-btn" id="hamburgerButton" title="Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

        <!-- Hamburger Menu Overlay -->
        <div class="menu-overlay hidden" id="menuOverlay">
            <div class="menu-content">
                <button class="menu-close" id="closeMenu">‚úï</button>
                <h2>Menu</h2>
                <nav class="menu-nav">
                    <a href="#" id="menuSettings" class="menu-item">
                        <span class="menu-icon">‚öôÔ∏è</span>
                        <span>Configuration</span>
                    </a>
                    <a href="#" id="menuShareLinks" class="menu-item">
                        <span class="menu-icon">üîó</span>
                        <span>Liens partag√©s</span>
                    </a>
                    <a href="#" id="menuExportHuman" class="menu-item">
                        <span class="menu-icon">üë§</span>
                        <span>Export pour un humain</span>
                    </a>
                    <a href="#" id="menuExportBackup" class="menu-item">
                        <span class="menu-icon">üíæ</span>
                        <span>Export pour r√©import</span>
                    </a>
                    <a href="#" id="menuLogout" class="menu-item">
                        <span class="menu-icon">üö™</span>
                        <span>D√©connexion</span>
                    </a>
                </nav>
            </div>
        </div>

        <!-- Floating Add Button -->
        <button class="fab" id="fabButton" title="Ajouter une trace"></button>

        <!-- Floating Filter Button -->
        <button class="filter-fab" id="filterButton" title="Filtrer les traces">üîç</button>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close" id="closeModal"></button>
            <img id="modalImage" src="" alt="">
            <div class="modal-info">
                <h3 id="modalPhotoName"></h3>
                <p id="modalPhotoLocation"></p>
            </div>
            <button id="deletePhotoBtn" class="btn-danger">Supprimer cette photo</button>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal hidden">
        <div class="modal-content modal-form">
            <button class="modal-close" id="closeUploadModal"></button>
            <h3>Ajouter une trace GPX</h3>
            <div class="upload-options">
                <label class="upload-option-btn">
                    <input type="file" id="gpxUploadFab" accept=".gpx" multiple hidden>
                    üìÅ S√©lectionner fichier(s) GPX
                </label>
            </div>
            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 1rem; text-align: center;">
                Les photos peuvent √™tre ajout√©es depuis l'√©dition d'une trace
            </p>
        </div>
    </div>

    <!-- Track Info Modal -->
    <div id="trackInfoModal" class="modal modal-fullscreen hidden">
        <div class="modal-content modal-fullscreen-content">
            <div id="trackInfoContent">
                <h3 id="trackInfoTitle" class="clickable-title">
                    <span class="back-arrow">‚Üê</span>
                    <span id="trackInfoTitleText"></span>
                </h3>

                <!-- Map container for the track -->
                <div style="position: relative;">
                    <div id="trackDetailMap" style="height: 300px; width: 100%; margin: 1rem 0; border-radius: 8px; overflow: hidden;"></div>
                    <button id="togglePhotosBtn" class="toggle-photos-btn" title="Afficher/Masquer les photos">üì∑</button>
                    <button id="expandMapBtn" class="expand-map-btn" title="Agrandir la carte">‚§¢</button>
                </div>

                <div class="track-info-stats">
                    <div class="track-stat-item">
                        <span class="track-stat-label">Distance:</span>
                        <span id="trackInfoDistance" class="track-stat-value"></span>
                    </div>
                    <div class="track-stat-item">
                        <span class="track-stat-label">D√©nivel√©:</span>
                        <span id="trackInfoElevation" class="track-stat-value"></span>
                    </div>
                    <div class="track-stat-item">
                        <span class="track-stat-label">Dur√©e:</span>
                        <span id="trackInfoDuration" class="track-stat-value"></span>
                    </div>
                    <div class="track-stat-item">
                        <span class="track-stat-label">Statut:</span>
                        <span id="trackInfoCompleted" class="track-stat-value"></span>
                    </div>
                </div>
                <div id="trackInfoCommentsContainer" class="track-info-comments" style="display: none;">
                    <p id="trackInfoComments"></p>
                </div>
                <div id="trackInfoLabelsContainer" class="track-info-labels" style="display: none;">
                    <div id="trackInfoLabels" class="labels-display-readonly"></div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" id="editTrackFromInfo">‚úèÔ∏è Modifier</button>
                    <button class="btn btn-secondary" id="downloadTrackFromInfo">‚¨áÔ∏è T√©l√©charger GPX</button>
                    <button class="btn btn-secondary" id="shareTrackBtn">üîó Partager</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Track Edit Modal -->
    <div id="trackEditModal" class="modal hidden">
        <div class="modal-content modal-form">
            <button class="modal-close" id="closeTrackEditModal"></button>
            <h3>√âditer la trace</h3>
            <form id="trackEditForm">
                <div class="form-group">
                    <label for="editTrackTitle">Titre:</label>
                    <input type="text" id="editTrackTitle" placeholder="Titre de la trace">
                </div>
                <div class="form-group">
                    <label for="editTrackType">Type:</label>
                    <select id="editTrackType">
                        <option value="hiking">Randonn√©e</option>
                        <option value="cycling">V√©lo route</option>
                        <option value="gravel" selected>Gravel</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editTrackColor">Couleur de la trace:</label>
                    <input type="color" id="editTrackColor" value="#2563eb">
                </div>
                <div class="form-group">
                    <label for="editTrackCompletedAt">Date de la ride :</label>
                    <input type="date" id="editTrackCompletedAt" placeholder="JJ/MM/AAAA">
                </div>
                <div class="form-group">
                    <label>Libell√©s:</label>
                    <div class="labels-container">
                        <div id="labelsDisplay" class="labels-display"></div>
                        <div class="label-input-group">
                            <input type="text" id="newLabel" placeholder="Ajouter un libell√©..." class="label-input">
                            <button type="button" class="btn btn-primary btn-small" id="addLabelBtn">Ajouter</button>
                        </div>
                        <div id="labelsSuggestions" class="labels-suggestions">
                            <small style="color: var(--text-secondary); margin-bottom: 0.5rem; display: block;">Libell√©s existants:</small>
                            <div id="labelsSuggestionsContainer" class="labels-suggestions-container"></div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editTrackComments">Commentaires:</label>
                    <textarea id="editTrackComments" rows="4" placeholder="Ajoutez vos commentaires..."></textarea>
                </div>
                <div class="form-group">
                    <label>Photos associ√©es:</label>
                    <div id="trackPhotosContainer" class="track-photos-grid">
                        <!-- Photos will be displayed here -->
                    </div>
                    <label class="btn btn-secondary btn-small" style="margin-top: 0.5rem;">
                        <input type="file" id="addTrackPhotos" accept="image/jpeg,image/jpg,image/png,image/webp" multiple hidden>
                        Ajouter des photos
                    </label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                    <button type="button" class="btn btn-secondary" id="cancelTrackEdit">Annuler</button>
                    <button type="button" class="btn btn-danger" id="deleteTrackBtn">Supprimer la trace</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Management Modal -->
    <div id="labelsManagementModal" class="modal hidden">
        <div class="modal-content modal-form">
            <button class="modal-close" id="closeLabelsManagementModal"></button>
            <h3>Param√®tres</h3>

            <!-- Tabs -->
            <div class="settings-tabs">
                <button class="settings-tab active" data-tab="general">G√©n√©ral</button>
                <button class="settings-tab" data-tab="labels">Libell√©s</button>
                <button class="settings-tab" data-tab="types">Types de trace</button>
                <button class="settings-tab" data-tab="gpxFiles">Fichiers GPX</button>
            </div>

            <!-- General Tab -->
            <div id="generalTab" class="settings-tab-content active">
                <div style="padding: 1rem;">
                    <div class="form-group">
                        <label for="averageSpeedInput">Vitesse moyenne (km/h)</label>
                        <input type="number" id="averageSpeedInput" min="1" max="50" step="0.5" value="17" style="width: 100px;">
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 0.5rem;">
                            Utilis√©e pour calculer la dur√©e estim√©e des traces
                        </p>
                    </div>
                </div>
            </div>

            <!-- Labels Tab -->
            <div id="labelsTab" class="settings-tab-content hidden">
                <div id="labelsManagementList" class="labels-management-list">
                    <!-- Labels will be displayed here -->
                </div>
            </div>

            <!-- Track Types Tab -->
            <div id="typesTab" class="settings-tab-content hidden">
                <button class="btn btn-primary btn-small" id="addTrackTypeBtn" style="margin-bottom: 1rem;">‚ûï Ajouter un type</button>
                <div id="trackTypesManagementList" class="labels-management-list">
                    <!-- Track types will be displayed here -->
                </div>
            </div>

            <!-- GPX Files Tab -->
            <div id="gpxFilesTab" class="settings-tab-content hidden">
                <div style="padding: 1rem;">
                    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 1rem;">
                        Liste de tous les fichiers GPX stock√©s sur le serveur.
                    </p>
                    <div id="gpxFilesList" class="gpx-files-list">
                        <!-- GPX files will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Track Type Form Modal -->
    <div id="trackTypeFormModal" class="modal hidden">
        <div class="modal-content modal-form">
            <button class="modal-close" id="closeTrackTypeFormModal"></button>
            <h3 id="trackTypeFormTitle">Ajouter un type de trace</h3>
            <form id="trackTypeForm">
                <div class="form-group">
                    <label for="trackTypeValue">Valeur (identifiant unique):</label>
                    <input type="text" id="trackTypeValue" placeholder="ex: mtb" required>
                    <small style="color: var(--text-secondary);">Minuscules sans espaces, ex: mtb, road, trail</small>
                </div>
                <div class="form-group">
                    <label for="trackTypeLabel">Libell√© (nom affich√©):</label>
                    <input type="text" id="trackTypeLabel" placeholder="ex: VTT" required>
                </div>
                <div class="form-group">
                    <label for="trackTypeIcon">Ic√¥ne emoji:</label>
                    <input type="text" id="trackTypeIcon" placeholder="ex: üöµ" required maxlength="4">
                    <small style="color: var(--text-secondary);">Un seul emoji</small>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                    <button type="button" class="btn btn-secondary" id="cancelTrackTypeForm">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Polyline Decorator for arrows -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.min.js"></script>

    <!-- EXIF reader for photo geotags -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <!-- Filter Modal -->
    <div id="filterModal" class="modal hidden">
        <div class="modal-content modal-form">
            <button class="modal-close" id="closeFilterModal"></button>
            <h3>Filtrer les traces</h3>

            <div class="filter-section">
                <h4>Statut</h4>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="radio" name="completionFilter" value="all" checked>
                        <span>Toutes</span>
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="completionFilter" value="completed">
                        <span>‚úÖ Faites</span>
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="completionFilter" value="todo">
                        <span>üìù √Ä faire</span>
                    </label>
                </div>
            </div>

            <div class="filter-section">
                <h4>Libell√©s</h4>
                <div class="filter-options" id="labelFiltersContainer">
                    <!-- Labels will be populated dynamically -->
                </div>
            </div>

            <div class="filter-section">
                <h4 id="distanceFilterTitle">Entre 0 km et 200 km</h4>
                <div class="distance-filter">
                    <div class="distance-slider-container">
                        <input type="range" id="minDistance" min="0" max="200" value="0" step="1" class="slider-thumb slider-thumb-min">
                        <input type="range" id="maxDistance" min="0" max="200" value="200" step="1" class="slider-thumb slider-thumb-max">
                        <div class="slider-track"></div>
                        <div class="slider-range" id="sliderRange"></div>
                    </div>
                    <div style="margin-top: 0.5rem; text-align: right;">
                        <label for="maxDistanceLimit" style="font-size: 0.875rem; color: var(--text-secondary);">Limite max:</label>
                        <input type="number" id="maxDistanceLimit" min="10" max="1000" value="200" step="10" style="width: 70px; padding: 0.25rem; margin-left: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem;">
                        <span style="margin-left: 0.25rem; font-size: 0.875rem; color: var(--text-secondary);">km</span>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-primary" id="applyFilters">Appliquer</button>
                <button type="button" class="btn btn-secondary" id="resetFilters">R√©initialiser</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close" id="closeShareModal"></button>
            <h3>Partager la trace</h3>

            <div class="share-info">
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    Cr√©ez un lien de partage √©ph√©m√®re pour cette trace. Le lien sera valide pendant 15 jours.
                </p>
            </div>

            <div id="shareLinksContainer" style="margin-top: 1.5rem;">
                <div id="shareLinksLoading" style="text-align: center; color: var(--text-secondary);">
                    Chargement...
                </div>
                <div id="shareLinksContent" style="display: none;">
                    <h4 style="margin-bottom: 1rem;">Liens actifs:</h4>
                    <div id="shareLinksList"></div>
                </div>
            </div>

            <div class="form-actions" style="margin-top: 1.5rem;">
                <button type="button" class="btn btn-primary" id="createShareLinkBtn">Cr√©er un nouveau lien</button>
            </div>
        </div>
    </div>

    <!-- All Share Links Modal -->
    <div id="allShareLinksModal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px;">
            <button class="modal-close" id="closeAllShareLinksModal"></button>
            <h3>Tous les liens partag√©s</h3>

            <div id="allShareLinksContainer" style="margin-top: 1.5rem;">
                <div id="allShareLinksLoading" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 1rem;">Chargement...</p>
                </div>
                <div id="allShareLinksContent" style="display: none;">
                    <div id="allShareLinksList"></div>
                </div>
                <div id="allShareLinksEmpty" style="display: none; text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <p>Aucun lien partag√© pour le moment.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom JS -->
    <script src="app.js?v=20251125-11"></script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);

                        // Check for updates every 30 seconds
                        setInterval(() => {
                            registration.update();
                        }, 30000);

                        // Listen for new service worker waiting to activate
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available, reload the page
                                    console.log('New version available! Reloading...');
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });

                // Listen for controller change (when new SW takes over)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('Controller changed, reloading page...');
                    window.location.reload();
                });
            });
        }
    </script>
</body>
</html>
